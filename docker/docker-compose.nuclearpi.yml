version: '3.8'

# NuclearHazard dev: builds from source with Pi 5 GPIO support.
# Run from repo root: docker-compose -f docker/docker-compose.nuclearpi.yml up
#
# IMPORTANT: Run the host setup first if not already done:
#   sudo raspi-config nonint do_serial_hw 0
#   sudo raspi-config nonint do_serial_cons 1
#   sudo raspi-config nonint do_i2c 0
#   sudo raspi-config nonint do_spi 0
#
# For pre-built image, use: docker-compose -f docker/docker-compose.nuclearpi.prod.yml up
services:
  nuclearhazard:
    build:
      context: ..
      dockerfile: docker/Dockerfile.nuclearpi
    container_name: nuclearhazard-server
    ports:
      - "80:5000"
      - "5000:5000"
    volumes:
      - nuclearhazard-dev-data:/app/data
      - /proc/device-tree:/proc/device-tree:ro
      - /sys:/sys
      - /run/udev:/run/udev:ro
    environment:
      - RH_DATA_DIR=/app/data
      - NH_FIRST_RUN=1
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/gpiochip0:/dev/gpiochip0
      - /dev/gpiomem:/dev/gpiomem
      - /dev/mem:/dev/mem
      - /dev/i2c-1:/dev/i2c-1
      - /dev/ttyAMA0:/dev/ttyAMA0

volumes:
  nuclearhazard-dev-data:
